name: Build Pigale

on:
  push:
    branches: [ main, master, 'claude/**', 'fix/**' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build on Ubuntu
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt5 and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qtbase5-dev \
          qt5-qmake \
          libqt5svg5-dev \
          freeglut3-dev \
          libglu1-mesa-dev \
          build-essential

    - name: Configure build
      run: |
        export QTDIR=/usr
        ./runqmake.sh

    - name: Build
      run: make -j$(nproc)

    - name: Verify binaries
      run: |
        echo "Checking built binaries..."
        ls -lh bin/
        file bin/*
        echo "Build successful!"

    - name: Upload binaries
      uses: actions/upload-artifact@v4
      with:
        name: pigale-linux-binaries
        path: |
          bin/pigale
          bin/client
          bin/pigale.cgi
          UsingTgraph/usingtgraph
        retention-days: 30

    - name: Upload libraries
      uses: actions/upload-artifact@v4
      with:
        name: pigale-linux-libraries
        path: |
          lib/*.a
          lib/*.prl
        retention-days: 30
